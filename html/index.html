<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Word Search Game Lobby</title>
    <link rel="stylesheet" href="style_lobby.css">
</head>
<body>
    <div id="lobbyContainer">
        <div id="userInputSection">
            <button id="helpButton">HELP</button>
            <button id="standbyButton">PUT ON STANDBY</button>
            <div>
                <label for="nickInput">Insert Nick:</label>
                <input type="text" id="nickInput" placeholder="Type here">
            </div>
            <div>
                <label for="gameSelect">Game:</label>
                <select id="gameSelect">
                  
                    <option value="game1">Game1</option>
                    <option value="game2">Game2</option>
                    <option value="game3">Game3</option>
                    <option value="game4">Game4</option>
                    <option value="game5">Game5</option>


                </select>
            </div>
            <div>
                <label for="modeSelect">Game Mode:</label>
                <select id="modeSelect">

                    <option value="2players">2 Players</option>
                    <option value="3players">3 Players</option>
                    <option value="4players">4 Players</option>

                </select>
            </div>
            <button id="confirmButton">CONFIRM</button>
            <h1>The Word Search Game</h1>
            <button id="startButton">START</button>
            <button id="leaveButton">LEAVE</button>
            <button id="refreshButton">Refresh</button>
        </div>
        <div id="gameListSection">

    </div>

    <!-- Timer section -->
    <div id="timerSection">
        <h2>Timer: <span id="timer">30</span> seconds</h2>
    </div>

    <!--Grid table-->
    
    <div>
        <input type="button" value="Generate Grid" onclick="generateGrid()"/>
        <table id="wordGrid">
            
        </table>
    </div>
</body>
<script>
    var socket = new WebSocket("ws://"+ window.location.hostname+":9105");
    
    class Player
    {
        nick="";
        score=0;
        status;
        totalPoints=0;
        gameWins=0;
    }

    class UserEvent
    {
        gameId=-1;
        player="";
        cell=-1;
        action=-1;
    }

    
    var gameId="";
    var player=new Player();
    socket.onopen = function(evt) {
        console.log("Open");
        requestGameList();
    };

    socket.onmessage = function(evt) {
       // console.log("Message received: " + evt.data);
        var messageData = JSON.parse(evt.data);
        console.log("Message received: " + messageData);
        const type= messageData.type;
        if(type==="JoinGame")
        {
            player= JSON.parse(messageData.player);
            game = JSON.parse(messageData.game);
            gameId= gameId+messageData.gameId;
            console.log(gameId);
        }

    };

        socket.onclose = function(evt) {
            console.log("WebSocket connection closed.");
            var nick = document.getElementById('nickInput').value.trim();
            if (nick) {
                leaveGame(nick);
            }
            document.getElementById("topMessage").innerText = "Server Offline";
        };


    socket.onerror = function(evt) {
        console.error("WebSocket error: " + evt.message);
    };

    

    function requestGameList() {
        var data = { type: "RequestGameList" };
        socket.send(JSON.stringify(data));
    }

    function updateGameList(serverData) 
    {
        var gameListSection = document.getElementById('gameListSection');
        gameListSection.innerHTML = ''; 

        serverData.forEach(function(game) {
            var gameDiv = document.createElement('div');
            gameDiv.innerHTML = '<span>' + game.gameName + '</span>' +
                            '<span>' + game.filledSlots + '/' + game.maxSlots + '</span>' +
                            '<button onclick="joinGame(' + game.gameId + ')">Join</button>';
            gameListSection.appendChild(gameDiv);
    });
    }

    // event listeners for user actions
    document.getElementById('confirmButton').addEventListener('click', function() {
        var nick = document.getElementById('nickInput').value.trim();
        var gameIndex = document.getElementById('gameSelect').value;
        var mode = document.getElementById('modeSelect').value;

        if (!nick) 
        {
            alert('Please enter a nickname.');
            return;
        }
        if (!gameIndex || !mode) 
        {
            alert('Please select a game and mode.');
            return;
        }
        joinGame(nick, gameIndex, mode);
    });


    // replace joinGame function with one that sends a WebSocket message
    function joinGame(nick, gameIndex, mode) {
        var data = {
            type: "JoinGame",
            nick: nick,
            gameIndex: gameIndex,
            modeIndex: mode
        };

        socket.send(JSON.stringify(data));
        console.log(JSON.stringify(data));
    }

    // replace leaveGame function with one that sends a WebSocket message
    function leaveGame(nick) {
        var data = {
            type: "LeaveGame",
            nick: nick
        };
        socket.send(JSON.stringify(data));
    }

    // event listener for the leave button
    document.getElementById('leaveButton').addEventListener('click', function() {
        var nick = document.getElementById('nickInput').value;
        leaveGame(nick);
    });

    // add an event listener for the refresh button to request the game list
    document.getElementById('refreshButton').addEventListener('click', function() {
        requestGameList();
    });


    //generate 25*25 grid

    //too big may have to do smaller grid or smaller cells
    function generateGrid()
    {
        const tbl = document.createElement("table");
        const tblBody = document.createElement("tbody");
        //create cells

        for(let i=0,k=0;i<25;i++)
        {
            //create rows
            const row = document.createElement("tr");
            for(let j=0;j<25;j++,k++)

            {
                //create cells and add it to the row
                const cell = document.createElement("td");
                cell.setAttribute("id",k.toString());
                
                
                const cellText=document.createTextNode(`${k}`);
                cell.appendChild(cellText);
                row.appendChild(cell);
            }

            //add row to the table body
            tblBody.appendChild(row);
        }
        tbl.appendChild(tblBody);
        document.body.appendChild(tbl);
        tbl.setAttribute("border","1.5");
        eventListener();
       
    }
    function eventListener()
    {
        var cells = document.querySelectorAll("td");
        for(var i=0;i<cells.length;i++)
        {
            cells[i].addEventListener("click",function()
            {
                buttonEvent(this.getAttribute("id"),0);
            });
            cells[i].addEventListener("mouseover",function()
            {
                buttonEvent(this.getAttribute("id"),1);
            });
            cells[i].addEventListener("mouseover",function()
            {
                buttonEvent(this.getAttribute("id"),2);
            });
            
        }
    }
    function buttonEvent(cell,action)
    {
        let button= document.getElementById(cell);
        button.style.backgroundColor="blue";
        U = new UserEvent();
        U.cell=parseInt(cell);
        U.action=action;
        U.player=player;
        U.gameId=gameId;

        var data = {
            type: "UpdateGame",
            events: U
        };
        socket.send(JSON.stringify(U));
        console.log(JSON.stringify(U));
    }

    // Timer countdown logic
    var timerElement = document.getElementById('timer');
    var timerInterval;

    function startTimer() {
        var timeLeft = 30; // 30 seconds
        updateTimerDisplay(timeLeft);

        timerInterval = setInterval(function() {
            timeLeft--;
            updateTimerDisplay(timeLeft);
            if (timeLeft === 0) {
                clearInterval(timerInterval);
                // Handle timer expiration (e.g., reset timer, end game)
            }
        }, 1000);
    }

    function updateTimerDisplay(time) {
            timerElement.textContent = time;
    }




</script>

